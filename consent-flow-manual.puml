@startuml consent-flow-manual
!theme cerulean-outline
skinparam backgroundColor #FEFEFE
skinparam defaultFontName Arial
skinparam defaultFontSize 13
skinparam sequenceMessageAlign center
skinparam BoxPadding 20
skinparam ParticipantPadding 20

title –ú–µ–∂–±–∞–Ω–∫–æ–≤—ã–µ —Å–æ–≥–ª–∞—Å–∏—è —Å —Ä—É—á–Ω—ã–º –æ–¥–æ–±—Ä–µ–Ω–∏–µ–º - Sequence Diagram\n<size:11><color:#666>HackAPI 2025 - Production-like Flow</color></size>

actor "–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ\n(team200)" as App #LightBlue
participant "–ë–∞–Ω–∫\n(SBank)" as Bank #90EE90
actor "–ö–ª–∏–µ–Ω—Ç\n(team200-1)" as Client #LightYellow
actor "–ë–∞–Ω–∫–∏—Ä\n(admin)" as Banker #LightPink

== –í–∞—Ä–∏–∞–Ω—Ç 2: –†—É—á–Ω–æ–µ –æ–¥–æ–±—Ä–µ–Ω–∏–µ –±–∞–Ω–∫–∏—Ä–æ–º (SBank) ==

note over App, Banker #FFE4B5
  **‚ö†Ô∏è –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –º–æ–≥—É—Ç –∏–∑–º–µ–Ω–∏—Ç—å—Å—è –ø–æ —Ö–æ–¥—É —Ö–∞–∫–∞—Ç–æ–Ω–∞.
  –¢–µ–∫—É—â–∏–µ: VBank, ABank - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ | SBank - –≤—Ä—É—á–Ω—É—é
end note

App -> Bank: **1Ô∏è‚É£ POST /auth/bank-token**\n?client_id=team200&client_secret=***
activate Bank
Bank --> App: <color:#28a745>200 OK</color> {access_token}
deactivate Bank

App -> Bank: **2Ô∏è‚É£ POST /account-consents/request**\nAuthorization: Bearer {token}\nX-Requesting-Bank: team200\n{\n  permissions: [...],\n  client_id: "team200-1"\n}
activate Bank
note right of Bank
  ‚è≥ **–°–æ–∑–¥–∞—ë—Ç –∑–∞–ø—Ä–æ—Å**
  –°—Ç–∞—Ç—É—Å: **pending**
  (–æ–∂–∏–¥–∞–µ—Ç –æ–¥–æ–±—Ä–µ–Ω–∏—è)
end note
Bank --> App: <color:#ffc107>200 OK</color>\n{\n  request_id: "req-xyz789",\n  status: "pending",\n  auto_approved: false\n}
deactivate Bank

Bank -> Client: üìß **–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ**\n"–ó–∞–ø—Ä–æ—Å –Ω–∞ –¥–æ—Å—Ç—É–ø\n–æ—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è team200"

Client -> Bank: **3Ô∏è‚É£ –õ–æ–≥–∏–Ω –≤ –±–∞–Ω–∫**\n/client/consents.html
activate Bank
Bank --> Client: –°—Ç—Ä–∞–Ω–∏—Ü–∞ —Å –∑–∞–ø—Ä–æ—Å–∞–º–∏
deactivate Bank

Client -> Client: **4Ô∏è‚É£ –ü—Ä–æ—Å–º–æ—Ç—Ä –∑–∞–ø—Ä–æ—Å–∞**\n- Permissions\n- Requesting app\n- –°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è

Client -> Bank: **5Ô∏è‚É£ –ù–∞–∂–∏–º–∞–µ—Ç "–ü–æ–¥–ø–∏—Å–∞—Ç—å"**\nPOST /account-consents/sign
activate Bank
note right of Bank
  ‚úÖ **–û–¥–æ–±—Ä—è–µ—Ç —Å–æ–≥–ª–∞—Å–∏–µ**
  –°—Ç–∞—Ç—É—Å: **active**
  –°–æ–∑–¥–∞—ë—Ç consent_id
end note
Bank --> Client: <color:#28a745>200 OK</color>\n–°–æ–≥–ª–∞—Å–∏–µ –æ–¥–æ–±—Ä–µ–Ω–æ
deactivate Bank

App -> Bank: **6Ô∏è‚É£ GET /accounts**\n(–ø–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞)\n?client_id=team200-1\nX-Consent-Id: consent-abc123
activate Bank
note right of Bank
  ‚úì –°–æ–≥–ª–∞—Å–∏–µ –Ω–∞–π–¥–µ–Ω–æ
  (—Ç–µ–ø–µ—Ä—å active)
end note
Bank --> App: <color:#28a745>200 OK</color> {accounts: [...]} 
deactivate Bank

note over App, Bank #FFE4B5
  **‚è±Ô∏è –ò—Ç–æ–≥–æ: 3 API –∑–∞–ø—Ä–æ—Å–∞ + 3 UI –¥–µ–π—Å—Ç–≤–∏—è –∫–ª–∏–µ–Ω—Ç–∞**
  –ü–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è: —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–π production flow, –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è –ø–æ–ª–Ω–æ–≥–æ —Ü–∏–∫–ª–∞
end note

@enduml